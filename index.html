<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculate Margin Level</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d0f14;
      --card: #161a22;
      --card-border: #252b36;
      --text: #e4e8ef;
      --text-muted: #8b92a0;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --input-bg: #1e232d;
      --input-border: #2d3544;
      --result-bg: #1a1f2e;
      --success: #22c55e;
      --slider-track: #2d3544;
      --slider-thumb: #3b82f6;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 1.5rem;
      line-height: 1.5;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 2rem;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.02em;
      margin: 0;
    }

    .card-header .xrp-price {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent);
    }

    .card-header .xrp-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-right: 0.25rem;
    }

    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem 1.25rem;
      margin-bottom: 1.25rem;
    }

    .field {
      margin-bottom: 1.25rem;
    }

    .input-grid .field {
      margin-bottom: 0;
    }

    .field label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.4rem;
    }

    .field input[type="number"] {
      width: 100%;
      padding: 0.65rem 0.9rem;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.95rem;
    }

    .field input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .slider-wrap {
      margin-bottom: 1.25rem;
    }

    .slider-wrap label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .slider-wrap .slider-value {
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent);
      font-weight: 600;
    }

    input[type="range"] {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--slider-track);
      border-radius: 4px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--slider-thumb);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--slider-thumb);
      cursor: pointer;
      border: none;
    }

    .results {
      margin-top: 1.75rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--card-border);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0 1.5rem;
    }

    .results .result-row {
      padding: 0.5rem 0;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem 0;
      font-size: 0.9rem;
    }

    .result-row .label {
      color: var(--text-muted);
    }

    .result-row .value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      color: #ac710f;
    }

    .result-row.highlight .value {
      color: var(--accent);
      font-size: 1rem;
    }

    .result-row.ml .value {
      color: var(--success);
      font-size: 1.1rem;
    }

    .result-row.debt-total .value {
      color: #df7676;
    }

    .result-row.cal-price-stop .value {
      color: #0f9eac;
    }

    .result-row.cal-price .value {
      color: #ac590f;
    }

    .info-wrap {
      position: relative;
      display: inline-flex;
      margin-left: 4px;
    }

    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      background: var(--input-border);
      border-radius: 50%;
      cursor: help;
    }

    .info-icon:hover {
      color: var(--accent);
    }

    .info-wrap .tooltip-box {
      position: absolute;
      left: 50%;
      bottom: calc(100% + 6px);
      transform: translateX(-50%);
      padding: 0.4rem 0.6rem;
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      font-size: 0.75rem;
      line-height: 1.4;
      color: var(--text);
      max-width: 220px;
      width: max-content;
      white-space: normal;
      word-wrap: break-word;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s, visibility 0.15s;
      z-index: 100;
      pointer-events: none;
    }

    .info-wrap:hover .tooltip-box {
      opacity: 1;
      visibility: visible;
    }

    .formula {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .load-input-wrap {
      display: flex;
      gap: 0.5rem;
      align-items: stretch;
    }

    .load-input-wrap input {
      flex: 1;
    }

    .load-btn {
      padding: 0.65rem 1.25rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .load-btn:hover {
      background: var(--accent-hover);
    }

    .load-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .slider-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .slider-control input[type="range"] {
      flex: 1;
    }

    .slider-btn {
      width: 36px;
      height: 36px;
      padding: 0;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slider-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
    }

  </style>
</head>
<body>
  <div class="card">
    <div class="card-header">
      <h1 class="card-title">Calculate Margin Level</h1>
      <span><span class="xrp-label">XRPUSDT </span><span class="xrp-price" id="xrpPrice">—</span></span>
    </div>

    <div class="field load-row" style="display: none;">
      <label>Config ID</label>
      <div class="load-input-wrap">
        <input type="number" id="configId" placeholder="4" step="1" value="4">
        <button type="button" id="loadBtn" class="load-btn">Load</button>
      </div>
    </div>

    <div class="input-grid">
      <div class="field">
        <label>Balance Value</label>
        <input type="number" id="x0" placeholder="0" step="any" value="2200">
      </div>
      <div class="field">
        <label>Debt</label>
        <input type="number" id="x1" placeholder="0" step="any" value="850">
      </div>
      <div class="field">
        <label>Order USD</label>
        <input type="number" id="x3" placeholder="0" step="any" value="18.8">
      </div>
      <div class="field">
        <label>Order Buy %</label>
        <input type="number" id="x6" placeholder="0" step="any" min="0" value="0.2">
      </div>
    </div>

    <div class="slider-wrap">
      <label>
        <span>Balance Value %</span>
        <span class="slider-value" id="sliderPercent">0%</span>
      </label>
      <div class="slider-control">
        <button type="button" id="percentDec" class="slider-btn" title="Decrease">&#8249;</button>
        <input type="range" id="percentSlider" min="0" max="100" step="0.01" value="0">
        <button type="button" id="percentInc" class="slider-btn" title="Increase">&#8250;</button>
      </div>
    </div>

    <div class="results">
      <div class="result-row">
        <span class="label">Balance from<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: x0 × (Balance Value % / 100)</span></span></span>
        <span class="value" id="x4">0</span>
      </div>
      <div class="result-row ml">
        <span class="label">ML<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: Total Balance / Debt รวม</span></span></span>
        <span class="value" id="ml">—</span>
      </div>
      <div class="result-row highlight">
        <span class="label">Total Balance<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: (x0 − x4) + มูลค่า Order</span></span></span>
        <span class="value" id="x2">0</span>
      </div>
      <div class="result-row debt-total">
        <span class="label">Debt รวม<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: Debt (x1) + มูลค่า Order</span></span></span>
        <span class="value" id="debtTotal">0</span>
      </div>
      <div class="result-row">
        <span class="label">จำนวน Order<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: Balance Value % / Order Buy % (x6)</span></span></span>
        <span class="value" id="x7">0</span>
      </div>
      <div class="result-row">
        <span class="label">มูลค่า Order<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: จำนวน Order × Order USD (x3)</span></span></span>
        <span class="value" id="orderValue">0</span>
      </div>
      <div class="result-row cal-price-stop">
        <span class="label">หยุดซื้อที่ราคา<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: XRPUSDT × (1 − Balance Value % / 100)</span></span></span>
        <span class="value" id="calPrice">—</span>
      </div>
      <div class="result-row">
        <span class="label">ทนลงได้ (%)<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: ((Debt รวม − Total Balance) / Total Balance) × 100</span></span></span>
        <span class="value" id="x2Percent">—</span>
      </div>
      <div class="result-row cal-price">
        <span class="label">Cal Price<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: หยุดซื้อที่ราคา × (1 + ทนลงได้ % / 100)</span></span></span>
        <span class="value" id="calPrice2">—</span>
      </div>
      <div class="result-row">
        <span class="label">Cal ทนลงได้ทั้งหมด (%)<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: (ราคา XRP ล่าสุด − Cal Price) / ราคา XRP ล่าสุด × 100</span></span></span>
        <span class="value" id="calTolerance">—</span>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://api.cayoshibot.com/api/Binace/Get_ML';
    const configIdEl = document.getElementById('configId');
    const loadBtn = document.getElementById('loadBtn');
    const x0El = document.getElementById('x0');
    const x1El = document.getElementById('x1');
    const x3El = document.getElementById('x3');
    const x6El = document.getElementById('x6');
    const percentSlider = document.getElementById('percentSlider');
    const sliderPercentEl = document.getElementById('sliderPercent');
    const x4El = document.getElementById('x4');
    const x2El = document.getElementById('x2');
    const x7El = document.getElementById('x7');
    const orderValueEl = document.getElementById('orderValue');
    const debtTotalEl = document.getElementById('debtTotal');
    const mlEl = document.getElementById('ml');
    const x2PercentEl = document.getElementById('x2Percent');
    const calPriceEl = document.getElementById('calPrice');
    const calPrice2El = document.getElementById('calPrice2');
    const calToleranceEl = document.getElementById('calTolerance');
    let xrpLastPrice = null;

    function num(v) {
      const n = parseFloat(v);
      return isNaN(n) ? 0 : n;
    }

    function formatNum(n) {
      if (n === null || n === undefined || isNaN(n)) return '—';
      if (Number.isInteger(n)) return n.toLocaleString();
      return Number(n.toFixed(4)).toLocaleString();
    }

    function calc() {
      const x0 = num(x0El.value);
      const x1 = num(x1El.value);
      const x3 = num(x3El.value);
      const x6 = num(x6El.value);
      const percent = num(percentSlider.value);

      const x4 = x0 * (percent / 100);
      const x7 = x6 !== 0 ? percent / x6 : 0;
      const orderValue = x7 * x3;
      const x2 = (x0 - x4) + orderValue;
      const debtTotal = x1 + orderValue;
      const ml = debtTotal !== 0 ? x2 / debtTotal : null;
      const x2Percent = x2 !== 0 ? ((debtTotal - x2) / x2) * 100 : null;

      sliderPercentEl.textContent = percent + '%';
      x4El.textContent = formatNum(x4);
      x2El.textContent = formatNum(x2);
      x7El.textContent = formatNum(x7);
      orderValueEl.textContent = formatNum(orderValue);
      debtTotalEl.textContent = formatNum(debtTotal);
      mlEl.textContent = ml !== null ? formatNum(ml) : '—';
      mlEl.style.color = ml == null ? '' : (ml > 1.5 ? 'var(--success)' : ml < 1.1 ? 'rgb(56, 56, 56)' : ml < 1.3 ? '#ef4444' : '#c56722');
      x2PercentEl.textContent = x2Percent !== null ? formatNum(x2Percent) + '%' : '—';
      const calPrice = (xrpLastPrice != null) ? xrpLastPrice * (1 - percent / 100) : null;
      const calPrice2 = (calPrice != null && x2Percent != null) ? calPrice * (1 + x2Percent / 100) : null;
      const calTolerance = (xrpLastPrice != null && xrpLastPrice !== 0 && calPrice2 != null) ? ((xrpLastPrice - calPrice2) / xrpLastPrice) * 100 : null;
      calPriceEl.textContent = calPrice != null ? formatNum(calPrice) : '—';
      calPrice2El.textContent = calPrice2 != null ? formatNum(calPrice2) : '—';
      calToleranceEl.textContent = calTolerance != null ? formatNum(calTolerance) + '%' : '—';
    }

    [x0El, x1El, x3El, x6El, percentSlider].forEach(el => {
      el.addEventListener('input', calc);
      el.addEventListener('change', calc);
    });

    const PERCENT_STEP = 0.01;
    const PERCENT_MIN = 0;
    const PERCENT_MAX = 100;

    function setPercent(v) {
      v = Math.max(PERCENT_MIN, Math.min(PERCENT_MAX, Math.round(v / PERCENT_STEP) * PERCENT_STEP));
      percentSlider.value = v;
      calc();
    }

    percentSlider.addEventListener('wheel', (e) => {
      e.preventDefault();
      let v = num(percentSlider.value);
      v += e.deltaY < 0 ? PERCENT_STEP : -PERCENT_STEP;
      setPercent(v);
    }, { passive: false });

    function holdRepeat(btn, delta) {
      let tid;
      const stop = () => {
        clearTimeout(tid);
        tid = null;
      };
      const repeat = (delay) => {
        setPercent(num(percentSlider.value) + delta);
        const next = Math.max(3, delay * 0.7);
        tid = setTimeout(() => repeat(next), next);
      };
      const start = () => {
        setPercent(num(percentSlider.value) + delta);
        if (!tid) {
          tid = setTimeout(() => repeat(200), 200);
        }
      };
      btn.addEventListener('mousedown', (e) => { e.preventDefault(); start(); });
      btn.addEventListener('mouseup', stop);
      btn.addEventListener('mouseleave', stop);
      btn.addEventListener('touchstart', (e) => { e.preventDefault(); start(); }, { passive: false });
      btn.addEventListener('touchend', stop);
      btn.addEventListener('touchcancel', stop);
    }
    holdRepeat(document.getElementById('percentDec'), -PERCENT_STEP);
    holdRepeat(document.getElementById('percentInc'), PERCENT_STEP);

    x6El.addEventListener('wheel', (e) => {
      e.preventDefault();
      const step = 0.01;
      const min = 0;
      let v = num(x6El.value);
      v += e.deltaY < 0 ? step : -step;
      v = Math.max(min, Math.round(v / step) * step);
      x6El.value = v;
      calc();
    }, { passive: false });

    x3El.addEventListener('wheel', (e) => {
      e.preventDefault();
      const step = 0.01;
      const min = 0;
      let v = num(x3El.value);
      v += e.deltaY < 0 ? step : -step;
      v = Math.max(min, Math.round(v / step) * step);
      x3El.value = v;
      calc();
    }, { passive: false });

    async function loadFromApi() {
      const configId = parseInt(configIdEl.value, 10) || 4;
      loadBtn.disabled = true;
      loadBtn.textContent = 'Loading…';
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ConfigId: configId })
        });
        const data = await res.json();
        if (data.success && data.totalBalance != null && data.totalDebt != null) {
          x0El.value = data.totalBalance;
          x1El.value = data.totalDebt;
          calc();
        }
      } catch (e) {
        console.error('API load failed:', e);
      } finally {
        loadBtn.disabled = false;
        loadBtn.textContent = 'Load';
      }
    }

    loadBtn.addEventListener('click', loadFromApi);
    loadFromApi();
    calc();

    const xrpPriceEl = document.getElementById('xrpPrice');
    async function fetchXrpPrice() {
      try {
        const res = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=XRPUSDT');
        const data = await res.json();
        if (data.lastPrice != null) {
          xrpLastPrice = parseFloat(data.lastPrice);
          xrpPriceEl.textContent =  xrpLastPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 });
        } else {
          xrpLastPrice = null;
          xrpPriceEl.textContent = '—';
        }
      } catch (e) {
        xrpLastPrice = null;
        xrpPriceEl.textContent = '—';
      }
      calc();
    }
    fetchXrpPrice();
    setInterval(fetchXrpPrice, 15000);
  </script>
</body>
</html>
