<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculate Margin Level</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d0f14;
      --card: #161a22;
      --card-border: #252b36;
      --text: #e4e8ef;
      --text-muted: #8b92a0;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --input-bg: #1e232d;
      --input-border: #2d3544;
      --result-bg: #1a1f2e;
      --success: #22c55e;
      --slider-track: #2d3544;
      --slider-thumb: #3b82f6;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 1.5rem;
      line-height: 1.5;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 2rem;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.02em;
      margin: 0;
    }

    .card-header .xrp-price {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent);
    }

    .card-header .xrp-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-right: 0.25rem;
    }

    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem 1.25rem;
      margin-bottom: 1.25rem;
    }

    .field {
      margin-bottom: 1.25rem;
    }

    .input-grid .field {
      margin-bottom: 0;
    }

    .field label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.4rem;
    }

    .field input[type="text"] {
      width: 100%;
      padding: 0.65rem 0.9rem;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.95rem;
    }

    .field input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .slider-wrap {
      margin-bottom: 1.25rem;
    }

    .slider-wrap label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .slider-wrap .slider-value {
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent);
      font-weight: 600;
    }

    input[type="range"] {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--slider-track);
      border-radius: 4px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--slider-thumb);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--slider-thumb);
      cursor: pointer;
      border: none;
    }

    .results {
      margin-top: 1.75rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--card-border);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0 1.5rem;
    }

    .results .result-row {
      padding: 0.5rem 0;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem 0;
      font-size: 0.9rem;
    }

    .result-row .label {
      color: var(--text-muted);
    }

    .result-row .value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      color: #ac710f;
    }

    .result-row.highlight .value {
      color: var(--accent);
      font-size: 1rem;
    }

    .result-row.ml .value {
      color: var(--success);
      font-size: 1.1rem;
    }

    .result-row.debt-total .value {
      color: #df7676;
    }

    .result-row.cal-price-stop .value {
      color: #0f9eac;
    }

    .result-row.cal-price .value {
      color: #ac590f;
    }

    .info-wrap {
      position: relative;
      display: inline-flex;
      margin-left: 4px;
    }

    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      background: var(--input-border);
      border-radius: 50%;
      cursor: help;
    }

    .info-icon:hover {
      color: var(--accent);
    }

    .info-wrap .tooltip-box {
      position: absolute;
      left: 50%;
      bottom: calc(100% + 6px);
      transform: translateX(-50%);
      padding: 0.4rem 0.6rem;
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      font-size: 0.75rem;
      line-height: 1.4;
      color: var(--text);
      max-width: 220px;
      width: max-content;
      white-space: normal;
      word-wrap: break-word;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s, visibility 0.15s;
      z-index: 100;
      pointer-events: none;
    }

    .info-wrap:hover .tooltip-box {
      opacity: 1;
      visibility: visible;
    }

    .formula {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .load-input-wrap {
      display: flex;
      gap: 0.5rem;
      align-items: stretch;
    }

    .load-input-wrap input {
      flex: 1;
    }

    .load-btn {
      padding: 0.65rem 1.25rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .load-btn:hover {
      background: var(--accent-hover);
    }

    .load-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .slider-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .slider-control input[type="range"] {
      flex: 1;
    }

    .slider-btn {
      width: 36px;
      height: 36px;
      padding: 0;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slider-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
    }

    .page-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .page-tab {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-muted);
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .page-tab:hover {
      color: var(--text);
      border-color: var(--card-border);
    }
    .page-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .page-panel {
      display: none;
      width: 100%;
      max-width: 900px;
    }
    .page-panel.active {
      display: block;
    }

    /* Price Decay tab – theme + same font as Margin Level */
    .page-decay {
      font-family: 'Outfit', sans-serif;
    }
    .page-decay .wrap { max-width: 1100px; margin: 0; padding: 0; }
    .page-decay h1 { margin: 0 0 14px; font-size: 18px; color: var(--text); }
    .page-decay .grid { display: grid; grid-template-columns: 360px 1fr; gap: 14px; }
    .page-decay .card { background: var(--card); border: 1px solid var(--card-border); border-radius: 14px; padding: 14px; }
    .page-decay .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .page-decay label { display: block; font-size: 12px; color: var(--text-muted); margin: 8px 0 6px; }
    .page-decay input, .page-decay select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text); outline: none; font-family: 'JetBrains Mono', monospace; }
    .page-decay input:focus, .page-decay select:focus { border-color: var(--accent); }
    .page-decay button { background: var(--accent); color: white; }
    .page-decay button.btn2 { background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); }
    .page-decay .muted { color: var(--text-muted); font-size: 12px; line-height: 1.5; }
    .page-decay .kpi { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .page-decay .pill { background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 12px; padding: 10px; }
    .page-decay .pill .t { font-size: 12px; color: var(--text-muted); }
    .page-decay .pill .v { font-size: 18px; margin-top: 3px; font-weight: 700; color: var(--text); font-family: 'JetBrains Mono', monospace; }
    .page-decay .tabs { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
    .page-decay .tab { padding: 8px 10px; border-radius: 999px; border: 1px solid var(--input-border); background: var(--input-bg); cursor: pointer; font-size: 12px; color: var(--text); }
    .page-decay .tab.active { background: var(--accent); border-color: var(--accent); color: white; }
    .page-decay canvas { width: 100%; height: 330px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 12px; }
    .page-decay table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 12px; }
    .page-decay th, .page-decay td { border-bottom: 1px solid var(--card-border); padding: 8px; text-align: right; color: var(--text); font-family: 'Outfit', sans-serif; }
    .page-decay td { font-family: 'JetBrains Mono', monospace; }
    .page-decay th { color: var(--text-muted); font-weight: 600; }
    .page-decay td:first-child, .page-decay th:first-child { text-align: center; }
    .page-decay .warn { color: #ffd7a8; }
    .page-decay .tools { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .page-decay button { width: 100%; margin-top: 12px; padding: 10px 12px; border: 0; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .page-decay button.btn2 { width: auto; margin-top: 0; }
    @media (max-width: 980px) { .page-decay .grid { grid-template-columns: 1fr; } }

  </style>
</head>
<body>
  <div class="page-tabs">
    <button type="button" class="page-tab active" data-page="margin">Margin Level</button>
    <button type="button" class="page-tab" data-page="decay">Price Decay 0.2%</button>
  </div>

  <div id="page-margin" class="page-panel active">
  <div class="card">
    <div class="card-header">
      <h1 class="card-title">Calculate Margin Level</h1>
      <span><span class="xrp-label">XRPUSDT </span><span class="xrp-price" id="xrpPrice">—</span></span>
    </div>

    <div class="field load-row" style="display: none;">
      <label>Config ID</label>
      <div class="load-input-wrap">
        <input type="text" id="configId" placeholder="4" value="4">
        <button type="button" id="loadBtn" class="load-btn">Load</button>
      </div>
    </div>

    <div class="input-grid">
      <div class="field">
        <label>Balance Value</label>
        <input type="text" id="x0" placeholder="0" value="2200">
      </div>
      <div class="field">
        <label>Debt</label>
        <input type="text" id="x1" placeholder="0" value="850">
      </div>
      <div class="field">
        <label>Order USD</label>
        <input type="text" id="x3" placeholder="0" value="18.8">
      </div>
      <div class="field">
        <label>Order Buy %</label>
        <input type="text" id="x6" placeholder="0" value="0.2">
      </div>
    </div>

    <div class="slider-wrap">
      <label>
        <span>Balance Value %</span>
        <span class="slider-value" id="sliderPercent">0%</span>
      </label>
      <div class="slider-control">
        <button type="button" id="percentDec" class="slider-btn" title="Decrease">&#8249;</button>
        <input type="range" id="percentSlider" min="0" max="100" step="0.01" value="0">
        <button type="button" id="percentInc" class="slider-btn" title="Increase">&#8250;</button>
      </div>
    </div>

    <div class="results">
      <div class="result-row">
        <span class="label">Balance from<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: x0 × (Balance Value % / 100)</span></span></span>
        <span class="value" id="x4">0</span>
      </div>
      <div class="result-row ml">
        <span class="label">ML<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: Total Balance / Debt รวม</span></span></span>
        <span class="value" id="ml">—</span>
      </div>
      <div class="result-row highlight">
        <span class="label">Total Balance<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: (x0 − x4) + มูลค่า Order</span></span></span>
        <span class="value" id="x2">0</span>
      </div>
      <div class="result-row debt-total">
        <span class="label">Debt รวม<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: Debt (x1) + มูลค่า Order</span></span></span>
        <span class="value" id="debtTotal">0</span>
      </div>
      <div class="result-row">
        <span class="label">จำนวน Order<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: Balance Value % / Order Buy % (x6)</span></span></span>
        <span class="value" id="x7">0</span>
      </div>
      <div class="result-row">
        <span class="label">มูลค่า Order<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: จำนวน Order × Order USD (x3)</span></span></span>
        <span class="value" id="orderValue">0</span>
      </div>
      <div class="result-row cal-price-stop">
        <span class="label">หยุดซื้อที่ราคา<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: XRPUSDT × (1 − Balance Value % / 100)</span></span></span>
        <span class="value" id="calPrice">—</span>
      </div>
      <div class="result-row">
        <span class="label">ทนลงได้ (%)<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: ((Debt รวม − Total Balance) / Total Balance) × 100</span></span></span>
        <span class="value" id="x2Percent">—</span>
      </div>
      <div class="result-row cal-price">
        <span class="label">Cal Price<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: หยุดซื้อที่ราคา × (1 + ทนลงได้ % / 100)</span></span></span>
        <span class="value" id="calPrice2">—</span>
      </div>
      <div class="result-row">
        <span class="label">Cal ทนลงได้ทั้งหมด (%)<span class="info-wrap"><span class="info-icon">!</span><span class="tooltip-box">สูตร: (ราคา XRP ล่าสุด − Cal Price) / ราคา XRP ล่าสุด × 100</span></span></span>
        <span class="value" id="calTolerance">—</span>
      </div>
    </div>
  </div>
  </div>

  <div id="page-decay" class="page-panel page-decay">
    <div class="wrap">
      <h1>คำนวณ "ลดลง 0.2%" จากราคาเริ่ม → ราคาปลาย (Compound vs Linear)</h1>
      <div class="grid">
        <div class="card">
          <div class="row">
            <div>
              <label>ราคาเริ่มต้น (Start)</label>
              <input id="start" type="text" value="3.6">
            </div>
            <div>
              <label>ราคาปลาย (Target)</label>
              <input id="target" type="text" value="0.522">
            </div>
          </div>
          <div class="row">
            <div>
              <label>เปอร์เซ็นต์ต่อครั้ง (%)</label>
              <input id="pct" type="text" value="0.2">
            </div>
            <div>
              <label>โหมด</label>
              <select id="mode">
                <option value="both">แสดงทั้งคู่ (Compound + Linear)</option>
                <option value="compound">Compound (ลด % จาก "ค่าก่อนหน้า")</option>
                <option value="linear">Linear (ลดคงที่ = % ของราคาเริ่ม)</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>ทศนิยมแสดงผล</label>
              <input id="dec" type="text" value="6">
            </div>
            <div>
              <label>จำกัดจำนวนแถวในตาราง</label>
              <input id="maxRows" type="text" value="200">
            </div>
          </div>
          <button id="btnCalc">Calculate</button>
          <div class="kpi">
            <div class="pill">
              <div class="t">จำนวนครั้ง (Compound)</div>
              <div class="v" id="kpiComp">-</div>
            </div>
            <div class="pill">
              <div class="t">จำนวนครั้ง (Linear)</div>
              <div class="v" id="kpiLin">-</div>
            </div>
            <div class="pill">
              <div class="t">ลดต่อครั้ง (Linear)</div>
              <div class="v" id="kpiStep">-</div>
            </div>
            <div class="pill">
              <div class="t">เช็กความถูกต้อง</div>
              <div class="v" id="kpiCheck">-</div>
            </div>
          </div>
          <p class="muted">
            <span class="warn">หมายเหตุ:</span> "Grid 0.2% จริงในตลาด" มักเป็นแบบ <b>Compound</b> (เปอร์เซ็นต์คูณจากราคาล่าสุด)
            ส่วน "Linear" คือการลบจำนวนคงที่เท่ากันทุกครั้ง (0.2% ของราคาเริ่ม)
          </p>
        </div>
        <div class="card">
          <div class="tabs">
            <div class="tab active" data-tab="chart">กราฟ</div>
            <div class="tab" data-tab="table">ตาราง</div>
            <div class="tab" data-tab="formula">สูตร</div>
          </div>
          <div id="tab-chart">
            <canvas id="cv" width="1200" height="420"></canvas>
            <div class="tools">
              <button class="btn2" id="btnDownloadCSV">Download CSV (ตาราง)</button>
              <button class="btn2" id="btnCopySummary">Copy Summary</button>
            </div>
            <div class="muted" id="summary" style="margin-top:10px;"></div>
          </div>
          <div id="tab-table" style="display:none;">
            <div class="muted">แสดงแถวแรก ๆ และแถวท้าย ๆ (รวมไม่เกินค่าที่กำหนด)</div>
            <div id="tableWrap"></div>
          </div>
          <div id="tab-formula" style="display:none;">
            <div class="muted" style="line-height:1.8;">
              <b>Compound:</b> ราคาแต่ละขั้น = <code>start × (1 - r)^n</code><br/>
              ต้องการหาจำนวนครั้งถึง target: <code>n = ceil( ln(target/start) / ln(1-r) )</code><br/><br/>
              <b>Linear:</b> ลดคงที่ต่อครั้ง = <code>start × r</code><br/>
              ราคาแต่ละขั้น = <code>start - n × (start×r)</code><br/>
              ต้องการหาจำนวนครั้งถึง target: <code>n = ceil( (start - target) / (start×r) )</code>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.querySelectorAll(".page-tab").forEach(function(btn) {
      btn.addEventListener("click", function() {
        var page = this.dataset.page;
        document.querySelectorAll(".page-tab").forEach(function(b) { b.classList.remove("active"); });
        this.classList.add("active");
        document.querySelectorAll(".page-panel").forEach(function(p) { p.classList.remove("active"); });
        document.getElementById("page-" + page).classList.add("active");
      });
    });

    const API_URL = 'https://api.cayoshibot.com/api/Binace/Get_ML';
    const configIdEl = document.getElementById('configId');
    const loadBtn = document.getElementById('loadBtn');
    const x0El = document.getElementById('x0');
    const x1El = document.getElementById('x1');
    const x3El = document.getElementById('x3');
    const x6El = document.getElementById('x6');
    const percentSlider = document.getElementById('percentSlider');
    const sliderPercentEl = document.getElementById('sliderPercent');
    const x4El = document.getElementById('x4');
    const x2El = document.getElementById('x2');
    const x7El = document.getElementById('x7');
    const orderValueEl = document.getElementById('orderValue');
    const debtTotalEl = document.getElementById('debtTotal');
    const mlEl = document.getElementById('ml');
    const x2PercentEl = document.getElementById('x2Percent');
    const calPriceEl = document.getElementById('calPrice');
    const calPrice2El = document.getElementById('calPrice2');
    const calToleranceEl = document.getElementById('calTolerance');
    let xrpLastPrice = null;

    function num(v) {
      const n = parseFloat(v);
      return isNaN(n) ? 0 : n;
    }

    function formatNum(n) {
      if (n === null || n === undefined || isNaN(n)) return '—';
      if (Number.isInteger(n)) return n.toLocaleString();
      return Number(n.toFixed(4)).toLocaleString();
    }

    function calc() {
      const x0 = num(x0El.value);
      const x1 = num(x1El.value);
      const x3 = num(x3El.value);
      const x6 = num(x6El.value);
      const percent = num(percentSlider.value);

      const x4 = x0 * (percent / 100);
      const x7 = x6 !== 0 ? percent / x6 : 0;
      const orderValue = x7 * x3;
      const x2 = (x0 - x4) + orderValue;
      const debtTotal = x1 + orderValue;
      const ml = debtTotal !== 0 ? x2 / debtTotal : null;
      const x2Percent = x2 !== 0 ? ((debtTotal - x2) / x2) * 100 : null;

      sliderPercentEl.textContent = percent + '%';
      x4El.textContent = formatNum(x4);
      x2El.textContent = formatNum(x2);
      x7El.textContent = formatNum(x7);
      orderValueEl.textContent = formatNum(orderValue);
      debtTotalEl.textContent = formatNum(debtTotal);
      mlEl.textContent = ml !== null ? formatNum(ml) : '—';
      mlEl.style.color = ml == null ? '' : (ml > 1.5 ? 'var(--success)' : ml < 1.1 ? 'rgb(56, 56, 56)' : ml < 1.3 ? '#ef4444' : '#c56722');
      x2PercentEl.textContent = x2Percent !== null ? formatNum(x2Percent) + '%' : '—';
      const calPrice = (xrpLastPrice != null) ? xrpLastPrice * (1 - percent / 100) : null;
      const calPrice2 = (calPrice != null && x2Percent != null) ? calPrice * (1 + x2Percent / 100) : null;
      const calTolerance = (xrpLastPrice != null && xrpLastPrice !== 0 && calPrice2 != null) ? ((xrpLastPrice - calPrice2) / xrpLastPrice) * 100 : null;
      calPriceEl.textContent = calPrice != null ? formatNum(calPrice) : '—';
      calPrice2El.textContent = calPrice2 != null ? formatNum(calPrice2) : '—';
      calToleranceEl.textContent = calTolerance != null ? formatNum(calTolerance) + '%' : '—';
    }

    [x0El, x1El, x3El, x6El, percentSlider].forEach(el => {
      el.addEventListener('input', calc);
      el.addEventListener('change', calc);
    });

    const PERCENT_STEP = 0.01;
    const PERCENT_MIN = 0;
    const PERCENT_MAX = 100;

    function setPercent(v) {
      v = Math.max(PERCENT_MIN, Math.min(PERCENT_MAX, Math.round(v / PERCENT_STEP) * PERCENT_STEP));
      percentSlider.value = v;
      calc();
    }

    percentSlider.addEventListener('wheel', (e) => {
      e.preventDefault();
      let v = num(percentSlider.value);
      v += e.deltaY < 0 ? PERCENT_STEP : -PERCENT_STEP;
      setPercent(v);
    }, { passive: false });

    function holdRepeat(btn, delta) {
      let tid;
      const stop = () => {
        clearTimeout(tid);
        tid = null;
      };
      const repeat = (delay) => {
        setPercent(num(percentSlider.value) + delta);
        const next = Math.max(3, delay * 0.7);
        tid = setTimeout(() => repeat(next), next);
      };
      const start = () => {
        setPercent(num(percentSlider.value) + delta);
        if (!tid) {
          tid = setTimeout(() => repeat(200), 200);
        }
      };
      btn.addEventListener('mousedown', (e) => { e.preventDefault(); start(); });
      btn.addEventListener('mouseup', stop);
      btn.addEventListener('mouseleave', stop);
      btn.addEventListener('touchstart', (e) => { e.preventDefault(); start(); }, { passive: false });
      btn.addEventListener('touchend', stop);
      btn.addEventListener('touchcancel', stop);
    }
    holdRepeat(document.getElementById('percentDec'), -PERCENT_STEP);
    holdRepeat(document.getElementById('percentInc'), PERCENT_STEP);

    x6El.addEventListener('wheel', (e) => {
      e.preventDefault();
      const step = 0.01;
      const min = 0;
      let v = num(x6El.value);
      v += e.deltaY < 0 ? step : -step;
      v = Math.max(min, Math.round(v / step) * step);
      x6El.value = v;
      calc();
    }, { passive: false });

    x3El.addEventListener('wheel', (e) => {
      e.preventDefault();
      const step = 0.01;
      const min = 0;
      let v = num(x3El.value);
      v += e.deltaY < 0 ? step : -step;
      v = Math.max(min, Math.round(v / step) * step);
      x3El.value = v;
      calc();
    }, { passive: false });

    async function loadFromApi() {
      const configId = parseInt(configIdEl.value, 10) || 4;
      loadBtn.disabled = true;
      loadBtn.textContent = 'Loading…';
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ConfigId: configId })
        });
        const data = await res.json();
        if (data.success && data.totalBalance != null && data.totalDebt != null) {
          x0El.value = data.totalBalance;
          x1El.value = data.totalDebt;
          calc();
        }
      } catch (e) {
        console.error('API load failed:', e);
      } finally {
        loadBtn.disabled = false;
        loadBtn.textContent = 'Load';
      }
    }

    loadBtn.addEventListener('click', loadFromApi);
    loadFromApi();
    calc();

    const xrpPriceEl = document.getElementById('xrpPrice');
    async function fetchXrpPrice() {
      try {
        const res = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=XRPUSDT');
        const data = await res.json();
        if (data.lastPrice != null) {
          xrpLastPrice = parseFloat(data.lastPrice);
          xrpPriceEl.textContent =  xrpLastPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 });
        } else {
          xrpLastPrice = null;
          xrpPriceEl.textContent = '—';
        }
      } catch (e) {
        xrpLastPrice = null;
        xrpPriceEl.textContent = '—';
      }
      calc();
    }
    fetchXrpPrice();
    setInterval(fetchXrpPrice, 15000);
  </script>
  <script>
  (function() {
    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
    function fmt(n, dec) { return Number.isFinite(n) ? n.toFixed(dec) : "NaN"; }
    function calcStepsCompound(start, target, r) {
      if (!(start > 0) || !(target > 0) || !(r > 0) || r >= 1) return { n: 0, series: [start] };
      if (target >= start) return { n: 0, series: [start] };
      var n = Math.ceil(Math.log(target / start) / Math.log(1 - r));
      var series = [];
      for (var i = 0; i <= n; i++) series.push(start * Math.pow(1 - r, i));
      return { n: n, series: series };
    }
    function calcStepsLinear(start, target, r) {
      if (!(start > 0) || !(r > 0) || r >= 1) return { n: 0, step: 0, series: [start] };
      if (target >= start) return { n: 0, step: start * r, series: [start] };
      var step = start * r;
      var n = Math.ceil((start - target) / step);
      var series = [];
      for (var i = 0; i <= n; i++) series.push(start - step * i);
      return { n: n, step: step, series: series };
    }
    function buildTable(mode, dec, maxRows, comp, lin) {
      var rows = [];
      var nMax = Math.max(comp.series.length, lin.series.length) - 1;
      for (var i = 0; i <= nMax; i++) {
        rows.push({
          step: i,
          compound: i < comp.series.length ? comp.series[i] : null,
          linear: i < lin.series.length ? lin.series[i] : null
        });
      }
      var limit = Math.max(20, Number(maxRows) || 200);
      var view = rows;
      var trimmed = false;
      if (rows.length > limit) {
        trimmed = true;
        var head = Math.floor(limit * 0.6), tail = limit - head;
        view = rows.slice(0, head).concat([{ step: "…", compound: null, linear: null }]).concat(rows.slice(rows.length - tail));
      }
      var html = '<table><thead><tr><th>Step</th><th>Compound</th><th>Linear</th></tr></thead><tbody>';
      for (var j = 0; j < view.length; j++) {
        var r = view[j];
        html += '<tr><td>' + r.step + '</td><td>' + (r.compound == null ? "" : fmt(r.compound, dec)) + '</td><td>' + (r.linear == null ? "" : fmt(r.linear, dec)) + '</td></tr>';
      }
      html += '</tbody></table>';
      if (trimmed) html += '<div class="muted" style="margin-top:8px;">* ตารางถูกตัดให้ไม่เกิน ' + limit + ' แถว</div>';
      return { html: html, rows: rows };
    }
    function drawChart(canvas, dec, mode, start, target, comp, lin) {
      var ctx = canvas.getContext("2d");
      var w = canvas.width, h = canvas.height;
      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = "#1e232d";
      ctx.fillRect(0, 0, w, h);
      var padL = 60, padR = 20, padT = 20, padB = 40;
      var plotW = w - padL - padR, plotH = h - padT - padB;
      var showComp = (mode === "both" || mode === "compound");
      var showLin = (mode === "both" || mode === "linear");
      var maxN = Math.max(showComp ? comp.series.length - 1 : 0, showLin ? lin.series.length - 1 : 0, 1);
      var yMin = target;
      if (showComp) yMin = Math.min(yMin, comp.series[comp.series.length - 1]);
      if (showLin) yMin = Math.min(yMin, lin.series[lin.series.length - 1]);
      var yMax = start;
      if (yMax - yMin < 1e-12) yMax = yMin + 1;
      var xToPx = function(x) { return padL + (x / maxN) * plotW; };
      var yToPx = function(y) { return padT + (1 - (y - yMin) / (yMax - yMin)) * plotH; };
      ctx.strokeStyle = "#2d3544";
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (var i = 0; i <= 10; i++) {
        ctx.moveTo(padL, padT + (i/10) * plotH);
        ctx.lineTo(padL + plotW, padT + (i/10) * plotH);
      }
      for (i = 0; i <= 10; i++) {
        ctx.moveTo(padL + (i/10) * plotW, padT);
        ctx.lineTo(padL + (i/10) * plotW, padT + plotH);
      }
      ctx.stroke();
      ctx.fillStyle = "#8b92a0";
      ctx.font = "12px Outfit, sans-serif";
      ctx.fillText("Price", 10, padT + 12);
      ctx.fillText("Step", padL + plotW/2 - 14, h - 10);
      for (i = 0; i <= 5; i++) {
        var yv = yMin + (i/5) * (yMax - yMin);
        ctx.fillText(fmt(yv, Math.min(6, dec)), 8, yToPx(yv) + 4);
      }
      ctx.strokeStyle = "#252b36";
      ctx.setLineDash([6, 6]);
      ctx.beginPath();
      ctx.moveTo(padL, yToPx(target));
      ctx.lineTo(padL + plotW, yToPx(target));
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = "#8b92a0";
      ctx.fillText("target " + fmt(target, Math.min(6, dec)), padL + 6, yToPx(target) - 6);
      function plot(series, stroke) {
        ctx.strokeStyle = stroke;
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (var k = 0; k < series.length; k++) {
          var x = xToPx(k), y = yToPx(series[k]);
          if (k === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
      }
      if (showComp) plot(comp.series, "#3b82f6");
      if (showLin) plot(lin.series, "#f59e0b");
      var lx = padL + 10, ly = padT + 14;
      ctx.fillStyle = "#e4e8ef";
      ctx.font = "12px Outfit, sans-serif";
      if (showComp) {
        ctx.fillStyle = "#3b82f6";
        ctx.fillRect(lx, ly - 10, 14, 3);
        ctx.fillStyle = "#e4e8ef";
        ctx.fillText("Compound", lx + 20, ly - 6);
        ly += 18;
      }
      if (showLin) {
        ctx.fillStyle = "#f59e0b";
        ctx.fillRect(lx, ly - 10, 14, 3);
        ctx.fillStyle = "#e4e8ef";
        ctx.fillText("Linear", lx + 20, ly - 6);
      }
    }
    function makeCSV(rows) {
      var lines = ["step,compound,linear"];
      for (var i = 0; i < rows.length; i++) {
        lines.push([rows[i].step, rows[i].compound ?? "", rows[i].linear ?? ""].join(","));
      }
      return lines.join("\n");
    }
    function downloadText(filename, text) {
      var blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function updateUI() {
      var start = Number(document.getElementById("start").value);
      var target = Number(document.getElementById("target").value);
      var pct = Number(document.getElementById("pct").value);
      var mode = document.getElementById("mode").value;
      var dec = clamp(Number(document.getElementById("dec").value || 6), 0, 12);
      var maxRows = clamp(Number(document.getElementById("maxRows").value || 200), 50, 5000);
      var r = pct / 100;
      var comp = calcStepsCompound(start, target, r);
      var lin = calcStepsLinear(start, target, r);
      document.getElementById("kpiComp").textContent = comp.n.toLocaleString();
      document.getElementById("kpiLin").textContent = lin.n.toLocaleString();
      document.getElementById("kpiStep").textContent = fmt(lin.step, dec);
      var compLast = comp.series[comp.series.length - 1];
      var linLast = lin.series[lin.series.length - 1];
      document.getElementById("kpiCheck").textContent = "C:" + (compLast <= target ? "OK" : "NO") + " | L:" + (linLast <= target ? "OK" : "NO");
      var summary = "Start=" + fmt(start, dec) + " → Target=" + fmt(target, dec) + " | step=" + pct + "%\nCompound: " + comp.n + " ครั้ง, ราคาหลังครั้งสุดท้าย=" + fmt(compLast, dec) + "\nLinear: " + lin.n + " ครั้ง, ลดคงที่/ครั้ง=" + fmt(lin.step, dec) + ", ราคาหลังครั้งสุดท้าย=" + fmt(linLast, dec);
      document.getElementById("summary").textContent = summary;
      var tb = buildTable(mode, dec, maxRows, comp, lin);
      document.getElementById("tableWrap").innerHTML = tb.html;
      drawChart(document.getElementById("cv"), dec, mode, start, target, comp, lin);
      document.getElementById("btnDownloadCSV").onclick = function() { downloadText("price_decay_steps.csv", makeCSV(tb.rows)); };
      document.getElementById("btnCopySummary").onclick = function() {
        navigator.clipboard && navigator.clipboard.writeText(summary);
        var btn = document.getElementById("btnCopySummary");
        btn.textContent = "Copied ✅";
        setTimeout(function() { btn.textContent = "Copy Summary"; }, 900);
      };
    }
    document.getElementById("btnCalc").addEventListener("click", updateUI);
    ["start", "target", "pct", "mode", "dec", "maxRows"].forEach(function(id) {
      document.getElementById(id).addEventListener("change", updateUI);
    });
    document.querySelectorAll("#page-decay .tab").forEach(function(t) {
      t.addEventListener("click", function() {
        document.querySelectorAll("#page-decay .tab").forEach(function(x) { x.classList.remove("active"); });
        this.classList.add("active");
        var tab = this.dataset.tab;
        document.getElementById("tab-chart").style.display = (tab === "chart") ? "" : "none";
        document.getElementById("tab-table").style.display = (tab === "table") ? "" : "none";
        document.getElementById("tab-formula").style.display = (tab === "formula") ? "" : "none";
      });
    });
    updateUI();
  })();
  </script>
</body>
</html>
